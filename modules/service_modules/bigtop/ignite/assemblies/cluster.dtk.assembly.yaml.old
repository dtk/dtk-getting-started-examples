---
name: cluster
description: cluster
dsl_version: 1.0.0
node_bindings:
  master: amazon_hvm-m4.large
  workers: amazon_hvm-medium
assembly:
  components:
  - bigtop_multiservice
  - hadoop::cluster:
      component_links:
        bigtop_multiservice: bigtop_multiservice
  - spark::cluster:
      component_links:
        bigtop_multiservice: bigtop_multiservice
  - ignite::cluster:
      attributes:
        version: 1.4.0
      component_links:
        bigtop_multiservice: bigtop_multiservice

  nodes:
    master:
      attributes:
        root_device_size: 30
      components:
      - bigtop_multiservice::hiera:
          component_links:
            bigtop_multiservice: bigtop_multiservice
      - bigtop_base:
          attributes:
            with_maven: true

      - dataset::hdfs[gitarchive1]:
          attributes:
            owner: ec2-user
            source:
              type: http
              file_directory_url: http://data.githubarchive.org
              files: 2015-03-01-{0..9}.json.gz
            target_directory: /user/local/ec2-user/data/gitarchive1
 
      - ignite:
          component_links:
            ignite::cluster: ignite::cluster

      - hadoop::namenode
      - hadoop::common_hdfs:
          component_links:
            hadoop::namenode: master/hadoop::namenode
      - hadoop::datanode
      - hadoop::hdfs_directories

      - spark::common:
          component_links:
            spark::master: master/spark::master
      - spark::worker
      - spark::master:
          attributes:
            eventlog_enabled: true
          component_links:
            hadoop::hdfs_directories: master/hadoop::hdfs_directories


    workers:
      attributes:
        cardinality: 1
        type: group
      components:
      - bigtop_multiservice::hiera:
          component_links:
            bigtop_multiservice: bigtop_multiservice
      - bigtop_base:
          attributes:
            with_maven: true

      - ignite:
          component_links:
            ignite::cluster: ignite::cluster

      - hadoop::common_hdfs:
          component_links:
            hadoop::namenode: master/hadoop::namenode
      - hadoop::datanode

      - spark::common:
          component_links:
            spark::master: master/spark::master
      - spark::worker

workflows:
  create:
    subtasks:
    - name: bigtop_multiservice
      components:
      - bigtop_multiservice
    - name: bigtop hiera
      components:
      - bigtop_multiservice::hiera
    - name: bigtop_base
      components:
      - bigtop_base

    - name: component ignite::cluster
      ordered_components:
      - ignite::cluster
    - name: ignite install and configure
      component:
      - ignite
    - name: start ignite on seed
      node: master
      actions:
      - ignite.start
    - name: start ignite on all other nodes
      node_group: workers
      actions:
      - ignite.start

    - name: namenode
      components:
      - hadoop::namenode
    - name: if needed leave safemode
      actions:
      - hadoop::namenode.leave_safemode
    - name: namenode smoke test
      actions:
      - hadoop::namenode.smoke_test
    - name: datanodes
      ordered_components:
      - hadoop::common_hdfs
      - hadoop::datanode
    - name: hdfs directories for spark
      component:
      - hadoop::hdfs_directories

    - name: spark master
      components:
      - spark::master
    - name: spark workers
      ordered_components:
      - spark::common
      - spark::worker

  restart_ignite_daemons:
    subtasks:
    - name: stop ignite deamons
      actions:
      - ignite.stop
    - name: start ignite on seed
      node: master
      actions:
      - ignite.start
    - name: start ignite on all other nodes
      node_group: workers
      actions:
      - ignite.start

  ignite_daemon_status:
    subtasks:
    - name: ignite daemon status
      actions:
      - ignite.status

  load_data_into_hdfs:
    #stub

  create_shared_spark_rdd:
    #stub
